%% Next line for the spell checker to disable warnings about $f(x)^2$ vs $f{(x)}^2$.
% chktex-file asdfqweasdfqwe3  
%%%
 
\documentclass[10pt, a4paper]{article}
%\documentclass[10pt, a4paper, openany, draft]{book}
    

%%%%%%%%%%%%%%%%%%%%
%%% To relabel equations with AUCTeX use the command
%%%   M-x reftex-renumber-simple-labels 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Standard packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% amsmath,amssymb,    

%\usepackage{graphicx}% Include figure files   
%\usepackage{dcolumn}% Align table columns on decimal point
 
%\usepackage[mathlines]{lineno}% Enable numbering of text and display math
%\linenumbers\relax % Commence numbering lines
 
\usepackage{enumerate}%i), ii) etc...

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
%\usepackage{mathptmx}

\usepackage{amsmath,amssymb}
\usepackage{mathtools}  
\usepackage{amsthm} %% For \newtheorem{}{}
\usepackage{mathrsfs} %% \mathscr
%\usepackage{stix} %% 
\usepackage{bbm} %% \mathbbm to get the blackboard bold 1
\usepackage{stmaryrd} %% to get [[ and ]] 

\usepackage{hyperref}

\usepackage{slashed}


\usepackage{soul} %% \ul for underline which wraps at the end of line

\usepackage{tikz}
\usepackage{tikz-cd} %% commutative diagrams
\usetikzlibrary{arrows}
\tikzcdset{arrow style=tikz, diagrams={>=stealth}} %%smaller arrow heads
\usepackage{graphicx}  

\usetikzlibrary{shapes.geometric,quotes}


\usepackage{simplewick}
%\usepackage{wick}

%\usepackage{genyoungtabtikz}



\usepackage{etoolbox}

%\usepackage{dsfont} %double stroke character alternative to \mathbb 
%\usepackage{amssymb}  %% For \mathbb %%% package is redundant when using 'stix' package
%\usepackage{bbold} %% must be placed *after* amssymb to get the nice \mathbb{1}
%\usepackage{bm}% bold math
%\usepackage{stix2}
%\usepackage{boondox-cal}
%\usepackage[cal=boondox]{mathalfa}
%\usepackage{pzccal}
%\usepackage{frcursive}
%%%%
%%%%%%%%[Standard packages]


%\usepackage[title]{appendix}
\usepackage{appendix}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%  Standard environments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[section]
\newtheorem*{theorem*}{Theorem} 
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}{Corollary}[theorem]

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\theoremstyle{definition}
\newtheorem*{definitions}{Definitions}
\theoremstyle{definition}
\newtheorem*{definition*}{Definition}

%\numberwithin{equation}{definition}

\theoremstyle{definition}
\newtheorem{remark}[theorem]{Remark}
\theoremstyle{definition}
\newtheorem*{remark*}{Remark}
\theoremstyle{definition}
\newtheorem{remarks}[theorem]{Remarks}
\theoremstyle{definition}
\newtheorem*{remarks*}{Remarks}

\theoremstyle{remark}
\newtheorem{claim}[theorem]{Claim}
%\theoremstyle{remark}
%\newtheorem*{claim*}[theorem]{Claim}
\theoremstyle{remark}
\newtheorem{idea}[theorem]{Idea}
\newtheorem{example}[theorem]{Example}
\newtheorem*{example*}{Example}
\newtheorem*{examples*}{Examples}

%%%  -------------------------------------------------------------------
%%%  Define a "rudin-style-paragraph" (:-D)
%%%  -------------------------------------------------------------------
%%%
%%% This is the better version which actually defines a *new* theorem style instead
%%% of re-defining the existing one...
\newtheoremstyle{rudin-style-generic}
	{}% <Space above>
	{}% <Space below>
	{}% <Body font>
	{}% <Indent amount>
	{\bfseries}% <Head font>
	{}% <Punctuation head>	
	{ }% <Space after head>
	% {\thmnumber{\S\hspace{2pt}#2} \thmname{#1.}\thmnote{\phantom{,}#3 }}% <Theorem head spec>
        {\thmnumber{#2} \thmname{#1.}\thmnote{\phantom{,}#3 }}% <Theorem head spec>
\newtheoremstyle{rudin-style-generic*}{}{}{}{}{\bfseries}{}{ }{\thmname{#1}\thmnote{#3}}
\theoremstyle{rudin-style-generic}
\newtheorem{parpar}{}[section]
\theoremstyle{rudin-style-generic*}
\newtheorem{parpar*}{}[]{}
%\AtEndEnvironment{parpar*}{\phantom{a}\null\hfill\S}%  %%% requires \usepackage{etoolbox}
%\AtEndEnvironment{parpar}{\null\hfill\S}%   %%% requires \usepackage{etoolbox}
\newenvironment{parpar-noproof}
  {%\renewcommand{\qedsymbol}{$\heartsuit$}%
   \pushQED{\qed}\begin{parpar}}
  {\popQED\end{parpar}}

%%% "Rudin" theorem-style with bodyfont = itshape
\newtheoremstyle{rudin-style-theorem}{}{}{\itshape}{}{\bfseries}{}{ }{\thmnumber{\S\hspace{2pt}#2} \thmname{#1.}\thmnote{\phantom{,}#3}}
\theoremstyle{rudin-style-theorem}
\newtheorem{parpar-theorem}[parpar]{Theorem}
\newtheorem{parpar-proposition}[parpar]{Proposition}
\newtheorem{parpar-lemma}[parpar]{Lemma}
\newtheorem{parpar-corollary}[parpar]{Corollary}

%%% "Rudin" proof-environment with wider left margin 
\newenvironment{parpar-proof}[1][\scshape    %%%\shshape=small cap font
\proofname]
{%
	\proof[#1]%
	\setlength{\leftskip}{3em}%
}
{%
	\endproof%
      }
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% New \ref command for paragraphs \begin{parpar}....\end{parpar}
%%%% ==============================================================
%%%% It needs to a custom .cwl file if one wants autocompletion as for \ref
%%%% For texstudio see:
%%%% https://tex.stackexchange.com/questions/414281/configuring-auto-completion-with-texstudio
%%%%
\newcommand{\parref}[1]{\S\textbf{\ref{#1}}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\more}[1]{{{\noindent{}\hspace{-2cm}\color{red}{{$\blacktriangleright[[${{#1}}$]]$}}}}}


%%%---------------------------------------------------------------------
%%%  -------------------------------------------------------------------
%%%  Proofs, QEDsymbol, etc, small paragraphs... 
%%%  -------------------------------------------------------------------
%%%
%%% Extract Yinyang from the package marvosym to use it as qed symbol :^)
%\newcommand{\YinYangQED}{{\usefont{U}{mvs}{m}{n}\symbol{89}}}
%%% Make the Yin Yang the qed symbol
%\renewcommand\qedsymbol{\YinYangQED}

%%%% Change the qed box at the end of proof (older version 2)
\newenvironment{funproof}[1][\scshape\proofname]
{%
	%\proof[#1]%
	\renewcommand*\qedsymbol{‌​$\square$ (claim)}%
	%\renewcommand*\qedsymbol{‌​$\YinYangQED$ (claim)}
}
{%
	\endproof%
}

%\newcommand*\shortProof{(\textit{Proof.})}
\newenvironment{shortproof}{{\small\scshape\proofname}.}{\hfill\footnotesize\qedsymbol}    
%% to use inside enumerate or itemize environments
%% the proof environment from amsthm would add too much white space
%%% small proof: a proof in small font
%% codied from
%% http://tex.stackexchange.com/questions/148955/how-to-change-the-font-size-of-all-theorem-environments
\newenvironment{smallproof}
	{%
	\vspace{.5em}
	\setlength\parindent{0pt}%
	\pushQED{\qed}%
	\textsc{\footnotesize\proofname}.
	\setlength{\leftskip}{3em}%
	}
	{%
		\endproof\footnotesize\qedhere\popQED%\hfill\footnotesize\qedsymbol%
	}
\AtBeginEnvironment{smallproof}{\footnotesize}   %%requires \usepackage{etoolbox}

\newenvironment{smallerparagraph}{}{}
\AtBeginEnvironment{smallerparagraph}{\small}    %%requires \usepackage{etoolbox}


%%% environment with custom font size
%% codied from
%% http://tex.stackexchange.com/questions/4139/how-to-change-font-size-mid-document
\newenvironment{computation}[1]
{%
	\clearpage
	\let\orignewcommand\newcommand
	\let\newcommand\renewcommand
	\makeatletter
	%\input{bk#1.clo}%% only for book class
	\input{size10.clo}%
	\makeatother
	\let\newcommand\orignewcommand
}
{%
	\clearpage
}

%%%%
%%%%%%%%[Standard environments]



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Standard notation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{mathtools}
\newcommand\SmallMatrix[1]{{%
  \tiny\arraycolsep=0.3\arraycolsep\ensuremath{\begin{pmatrix}#1\end{pmatrix}}}}

\newcommand{\todo}[1]{{\color{red}\textit{[TO-DO#1]}}}


\newcommand{\deq}{\stackrel{\mathrm{def}}{=}}
\newcommand{\dd}{\,\mathrm{d}}
\newcommand{\ii}{\mathrm{i}}
\newcommand{\id}{\,\mathbb{I}}
\DeclareMathOperator*{\Dom}{Dom}
\DeclareMathOperator*{\Ran}{Range}
\newcommand{\PP}{{\mathbb{P}}}
\newcommand{\QQ}{{\mathbb{Q}}}
\newcommand{\KK}{{\mathbb{K}}}


\newcommand{\NN}{\mathbb N}
\newcommand{\ZZ}{\mathbb Z}
\newcommand{\RR}{\mathbb R}
\newcommand{\CC}{\mathbb C}

\newcommand{\Gg}{{\mathbf{G}}}
\newcommand{\Hg}{{\mathbf{H}}}
\newcommand{\Ng}{{\mathbf{N}}}
\newcommand{\Sg}{{\mathbf{S}}}


\newcommand{\HH}{\mathbb H}
\newcommand{\TT}{\mathbb T} %% torus
\newcommand{\Mat}{\mathrm M} %% space of matrices
\DeclareMathOperator{\tr}{Tr}
\DeclareMathOperator{\Span}{Span}
\DeclareMathOperator{\idfunction}{id}

%\newcommand{\st}{\left|\vphantom{\tfrac{1}{2}}\right.}
\renewcommand{\st}{\,\mathbf:\,}
%\newcommand{\st}{\,\mathbf:\,}
\newcommand{\ST}{\,\mathbf:\,}
\newcommand{\setset}[2]{\left\{#1\;  \mathbf: \; #2  \right\}}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% permanent, hafnian, pfaffian
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DeclareMathOperator*{\pf}{pf}
\DeclareMathOperator*{\haf}{haf}
\DeclareMathOperator*{\per}{per}

%%% sign (of a permutation for example)
\DeclareMathOperator*{\sgn}{sgn}

%% Tensor algebras
\newcommand*{\TAlg}[1]{\Gamma_{\!\otimes}#1}
\newcommand*{\SymTAlg}[1]{\Gamma_{\!\odot}#1}
\newcommand*{\AntiTAlg}[1]{\Gamma_{\!\wedge}#1}
%% Bosonic Fock space:
%\newcommand*\BFock[1]{\bigodot\!#1} 
\newcommand*\BFock[1]{\mathbb\Gamma_{\!\odot}#1} 
%% Fermionic Fock space:
%\newcommand*\FFock[1]{\bigwedge\!#1} 
\newcommand*\FFock[1]{\mathbb\Gamma_{\!\wedge}#1}
%% General Fock space:
%\newcommand*\GFock[1]{\bigotimes\!#1} %{\mathscr{F}_{\otimes}}
\newcommand*\GFock[1]{\mathbb\Gamma_{\!\otimes}#1} %{\mathscr{F}_{\otimes}}
%% Finite number of particles - Scwartz wave functions - Bosonic Fock space
\newcommand*\FSBFock{{\mathscr{F}_{s}^{0}}} 
%% Deprecated
\newcommand*{\FockNew}{{%
		\text{\fontencoding{OT2}\selectfont\char3}% %\char3,\char5,\char88,\char16,\char17, I
}}


%%% (LIE) ALGEBRA %%%
\newcommand*{\Cliff}{\mathcal C\ell}
\newcommand*{\CCliff}{\CC\ell}
\newcommand*{\SO}{\mathbf{SO}}
\newcommand*{\SU}{\mathbf{SU}}
\newcommand*{\UU}{\mathbf{U}}
\newcommand*{\Spin}{\mathbf{Spin}}
\newcommand*{\Pin}{\mathbf{Pin}}
\newcommand*{\SL}{\mathbf{SL}}
\newcommand*{\SLL}{{\mathbf{SL}(2,\CC)}}
\newcommand*{\SLLR}{{{\mathbf{SL}(2,\CC)}_\RR}}
\newcommand*{\iSLLR}{{{\mathbf{ISL}(2,\CC)}_\RR}}

\newcommand*{\GL}{\mathbf{GL}}
\newcommand*{\Sp}{\mathbf{Sp}}
\newcommand*{\PoiUC}{\widetilde{\mathbf{\Pi}}}
\newcommand*{\ISpin}{\mathbf{ISpin}}
\newcommand*{\IPin}{\mathbf{IPin}}
\newcommand*{\ISO}{\mathbf{ISO}}
\newcommand*{\ad}{\mathfrak{a}\;\!\!\mathfrak{d}}
\newcommand*{\Ad}{\text{Ad}\,}
\newcommand*{\End}{\text{End}\,}
\newcommand*{\Aut}{\text{Aut}\,}
\newcommand*{\Diff}{\text{Diff}\,}
\newcommand*{\Gau}{\text{Gau}\,}

\newcommand*{\Oup}{{\mathscr{O}_{\mathring{v}}^\uparrow}} %% upper hyperboloid
\newcommand*{\dOup}{{\dd_{\mathring v}^\uparrow}} %% measure on upper hyperboloid

% \newcommand*{\rest}{\!\!\upharpoonright} %% restriction symbol
\newcommand*{\rest}{{\upharpoonright}} %% restriction symbol

\newcommand*{\ElleUpDown}{L}
\newcommand*{\ElleUp}{{L^\Up}}
\newcommand*{\ElleDown}{L^\Down}
\newcommand*{\elleUpDown}{l}
\newcommand*{\elleUp}{{l^\Up}}
\newcommand*{\elleDown}{{l^\Down}}
\newcommand*{\poff}{\mathpzc{p}}
\newcommand*{\MC}{{\mathrm{M}_{\mathtt{C}}}}
\newcommand*{\dotprod}{{\boldsymbol{\cdot}}}
\newcommand*{\scalareta}[2]{{\langle{} {#1},{#2}{\rangle}_{\!\eta}}}
\newcommand*{\scalardelta}[2]{{\langle{} {#1},{#2}{\rangle}_{\!\delta}}}


\newcommand*{\pUp}{{p^\Up}}
\newcommand*{\pUpDown}{{p}}
\newcommand*{\pDown}{{p^\Down}}
\newcommand*{\pST}{{\mathcal p}}

\newcommand*{\fin}{{f^{\text{in}}}}
\newcommand*{\SET}[1]{{\{ 0, \dots, #1 - 1 \}}}
\newcommand*{\boldcol}{{\,\boldsymbol{:}\,}} 
\DeclareFontEncoding{LS1}{}{}
\DeclareFontSubstitution{LS1}{stix}{m}{n}
\DeclareSymbolFont{symbols2}{LS1}{stixfrak}{m}{n}
\DeclareMathSymbol{\typecolon}{\mathbin}{symbols2}{"25}


% completed direct sum and product
\DeclareMathOperator*{\Hoplus}{\widehat\oplus}
\DeclareMathOperator*{\Hbigoplus}{\widehat{\bigoplus}}
\DeclareMathOperator*{\Hotimes}{\widehat\otimes}
\DeclareMathOperator*{\Hsymtimes}{\widehat\odot}
\DeclareMathOperator*{\Hantitimes}{\widehat\wedge}
\DeclareMathOperator*{\Hwedge}{\hat{\wedge}}

%%% PROBABILITY %%%
\newcommand{\Expect}{\mathbb{E}}
\newcommand{\Var}{\mathrm{Var}}
\newcommand{\Cov}{\mathrm{Cov}}




%%% exterior algebra symbol (similar to a big \Lambda)
%%% taken from: http://tex.stackexchange.com/questions/61637/wedge-power-symbol
\makeatletter
\newcommand{\extp}{\@ifnextchar^\@extp{\@extp^{\,}}}
\def\@extp^#1{\mathop{\bigwedge\nolimits^{\!#1}}}
\makeatother
%%% -- edit -- now it seams to work.. (??:^)
%%% the previous commented section would be better but causes unexpected problems.. ;(
%%% so I make do with the following
%\newcommand*{\Extern}{\displaystyle\bigwedge\!}
%%% --- edit --- since now the sofisticated method above seams to work I now define the following
\newcommand*{\Extern}{{\extp}}


%\usepackage{accents}
%\newcommand{\ubar}[1]{\underaccent{\bar}{{#1}}}

\usepackage{stackengine}

\newcommand\ubar[1]{\stackunder[1.2pt]{$#1$}{\rule{.8ex}{.075ex}}}
%%%%
%%%%%%%%[Standard notation]


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Notation for  Dirac Rosetta stone
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\usepackage{MnSymbol} %% I need \ostar
%\newcommand{\ostar}{{{\textcircled{$\star$}}}}
%\usepackage{wasysym}
%\newcommand{\ostar}{{\APLlog}}
%\newcommand{\ostar}{{\circledast}}


% \newcommand{\PPpar}{{\mathbb P_{\mathrm{par}}}}
%\newcommand{\PPant}{{\mathbb P_{\mathrm{ant}}}}
\newcommand{\Par}{{\mathrm{par}}}
\newcommand{\Ant}{{\mathrm{ant}}}
\newcommand{\FW}{{\mathrm{FW}}}
\newcommand{\ParRed}{\mathrm{PAR}}
\newcommand{\AntRed}{\mathrm{ANT}}

\newcommand{\tildegamma}{{\tilde{\gamma}}}


\newcommand{\Even}{{\mathrm{even}}}
\newcommand{\Odd}{{\mathrm{odd}}}

\newcommand{\Orbit}{{\mathscr{O}_m^{\uparrow}}}

\newcommand{\Vone}{{W}}
\newcommand{\Vtwo}{{V}}
\newcommand{\TZSpace}{{\mathfrak{H}}} %% time-zero space
\newcommand{\TZDom}{{\mathscr S(\RR^3)\otimes\Vtwo}} %% time-zero domain
\newcommand{\CovSpace}{{\mathcal{H}}} %% covariant space
\newcommand{\DiracSpace}{{\mathcal{H}_{\mathrm{D}}}}
\newcommand{\PASpace}{{\mathcal{V}}} %% particle-antiparticle space
\newcommand{\pa}{{\mathcal{v}}} %% particle-antiparticle wave function
\newcommand{\PNSpace}{{\mathcal{V}'}} %% positive-negative energy space
\newcommand{\pn}{{\mathcal{v}'}} %% positive-negative energy wave function


\newcommand{\Orb}{{\mathscr{O}}} %% Orbit for  Spin = Spin^0 U {\gamma_5}
\newcommand{\OrbUp}{{\mathscr{O}_{m^2}^{\uparrow}}} %% Orbit for  Spin^0, p_0>0
\newcommand{\OrbDown}{{\mathscr{O}_{m^2}^{\downarrow}}} %% Orbit for  Spin^0, p_0<0
\newcommand{\OrbUpDown}{{\mathscr{O}_{m^2}^{\uparrow} \cup \mathscr{O}_{m^2}^{\downarrow}}} 

\newcommand{\Fpa}{{\mathcal{F}_{(1)}}} %% Fock 1-(particle+antiparticle) space (Wigner representation for both par and antipar)
%\newcommand{\Hpa}{{\mathcal{H}_{\mathbf{p}}}}  %% Complex-twisted particle+antiparticle space (Charge conj. anti-unitary)
\newcommand{\VSpin}{{\mathcal{V}}} %% Carrier space for rep of \RR x Spin = \RR x (Spin^0 U {\gamma_5})
\newcommand{\Hpn}{{\mathcal{H}_{\updownarrow}}} %% (Positive-negative energy)-twisted space space
\newcommand{\HD}{{\mathcal{H}_{D}}} %% Dirac space (covariant space in momentum representation)
\newcommand{\WSpinzero}{{\mathcal{H}_{\uparrow}}} %% Standard Wigner rep space for particle & antiparticles


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% SPACES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\Hgeneric}{{\mathcal{W}}}
\newcommand{\fgeneric}[1][]{{w_{#1}}}
\newcommand{\fgenericslashed}[1][]{{\slashed{w}_{#1}}}

\newcommand{\Virr}{{W}}
\newcommand{\Vred}{{V}}

\newcommand{\wigner}{{\uparrow}}
\newcommand{\Hwigner}{{\mathcal{W}_\wigner}}
\newcommand{\fwigner}[1][]{{w_{#1}^\wigner}}


\newcommand{\parant}{{\uparrow\oplus\uparrow}}
\newcommand{\Hpa}{{\mathcal{W}_\parant}}
\newcommand{\HpaExtended}{{\mathcal{V}_\parant}}
\newcommand{\HpaExtendedCovariant}{{ {\vphantom{|}\mathcal{V}}^{\ElleUp}_{\parant} }}
\newcommand{\fpa}[1][]{{\mathcal{v}_{#1}}}
\newcommand{\fpaext}[1][]{{v_{#1}^\parant}}






\newcommand{\FF}{{\uparrow\oplus\downarrow}} %%FF: field-function 
\newcommand{\Hff}{\mathcal{K}_\FF} %% Wigner field-function space 
\newcommand{\HffCovariant}{{ {\vphantom{|}\mathcal{K}}^{\ElleUpDown}_{\FF} }} %% Covariant field-function space
\newcommand{\HffExtended}{{\mathcal{H}_\FF}} %% Extended Wigner field-function space 
\newcommand{\HffExtendedCovariant}{{ {\vphantom{|}\mathcal{H}}^{\ElleUpDown}_{\FF} }}
\newcommand{\fff}[1][]{{f_{#1}^\FF}}
\newcommand{\fffext}[1][]{{f_{#1}^\FF}}
% \newcommand{\Hcov}[1][]{{{\HffExtendedCovariant}}} %%
\newcommand{\Hcov}[1][]{{{\mathcal{H}^{\textrm{cov}}_{#1}}}} %%
\newcommand{\HPhi}{{\mathcal{H}_{\Phi}}} %%
\newcommand{\HPi}{{\mathcal{H}_{\Pi}}} %%

\newcommand{\fcov}[1][]{{{f_{#1}}}} %% argument of the fields
\newcommand{\fST}[1][]{{{\varphi}}} %% space time test function
\newcommand{\fzero}[1][]{{{F_{#1}}}} %% time-zero function


%%%% ALIASES FOR SPACES:
%%%% irr, red  ;   pa, ff  ;  wigner, cov
%%%%
%%%% \Hpa
%%%% \HPA    \HPAcov
%%%% \HFF    \HFFcov
%%%% \Hff    \Hffcov
%%%%
\newcommand{\HPA}{\HpaExtended}
\newcommand{\HFF}{\HffExtended}
\newcommand{\HPAcov}{\HpaExtendedCovariant}
\newcommand{\HFFcov}{\HffExtendedCovariant}
\newcommand{\Hffcov}{\HffCovariant}

%%%% FIELDS
\newcommand{\fieldKG}{{\phi}}
\newcommand{\fieldIrr}{{\psi}}
\newcommand{\fieldCoord}{{\Phi}}
\newcommand{\fieldMoment}{{\Pi}}

\newcommand{\STfieldKG}{{\phi}}
\newcommand{\STfieldReduced}{{\psi}}
\newcommand{\STfieldCoord}[1][{0}]{{\Phi_{#1}}}
\newcommand{\STfieldMoment}[1][{0}]{{\Pi_{#1}}}

\let\div\relax
\DeclareMathOperator{\div}{{\mathrm{div}}}


%%% OLD

\newcommand{\Hextended}{{\mathcal{V}_\Up}}
\newcommand{\fextended}[1][]{{v_{#1}^\Up}}
\newcommand{\HextendedDown}{{\mathcal{V}_\Down}}



\newcommand{\total}{{\uparrow\oplus\downarrow}}
\newcommand{\Htotal}{{\mathcal{H}_\total}}
\newcommand{\ftotal}{{f^\total}}
\newcommand{\ptotal}[1][]{{p_{#1}^\total}}

\newcommand{\reduced}{{\updownarrow}}
\newcommand{\Hreduced}{{\mathcal{H}_\reduced}}
\newcommand{\freduced}{{f^\reduced}}

\newcommand{\cov}{{\mathrm{cov}}}
\newcommand{\Htotalcov}{{\mathcal{H}_\cov}}  %{{\mathcal{H}_\total^L}}
\newcommand{\ftotalcov}[1][]{{{f_{#1}^\cov}}}

\newcommand{\Hcoord}{{\mathcal{H}_\cov^\phi}}
\newcommand{\fcoord}[1][]{{f_{#1}^\phi}}
\newcommand{\Hmoment}{{\mathcal{H}_\cov^\pi}}
\newcommand{\fmoment}[1][]{{f_{#1}^\pi}}

\newcommand{\redcov}{}
\newcommand{\Hredcov}{{\mathcal{K}_\redcov}}
\newcommand{\fredcov}{{f^\reduced}}


\newcommand{\Wightman}[1][]{{\mathrm{W}_{\!{#1}}}}
\newcommand{\Wightmandual}{{\tilde{\mathrm{W}}}}
\newcommand{\Wfunction}{{\mathcal{w}}}
\newcommand{\Wfunctiondual}{{\tilde{\mathscr{W}}}}
\newcommand{\Sfunction}{{\mathcal{S}}}




\def\ccar#1#2{{{[ {#1} , {#2} ]}_\ostar}}
\newcommand{\piUp}{{\varpi_\Up}}
\newcommand{\piDown}{{\varpi_\Down}}
\newcommand{\piUpDown}{{\varpi_{\Up\cup\Down}}}
\newcommand{\restUpDown}{{{\rest_{\Up\cup\Down}}}}

\DeclareMathOperator*{\Inv}{{\mathrm{Inv}}}


\newcommand{\BoseFermiFock}[1][\!]{{\Gamma_{\!\ostar}{#1}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%





\newcommand{\dirac}{{D}}
\newcommand{\Hdirac}{{\mathcal{H}_\dirac}}
\newcommand{\fdirac}{{f_\dirac}}

\newcommand{\Hparticle}{{\mathcal{W}_\uparrow}}
\newcommand{\fparticle}{{w_\uparrow}}
\newcommand{\Hfield}{{\mathcal{H}}}
\newcommand{\ffield}{{f}}
\newcommand{\Sfield}{{\mathcal{S}}}

\newcommand{\HwignerRed}{{\mathcal{V_\Up}}} %%% Wigner space for ``reducible particle''
\newcommand{\HwignerRedDown}{{\mathcal{V_\Down}}} %%% Wigner space for ``reducible particle''
\newcommand{\Hwignertotal}{{\mathcal{U}_\Up}} %%% Total space of reducible PAR & ANT
\newcommand{\Hwignertotalcov}{{\mathcal{U}_\Up^{\ElleUp}}} %%% Total space of reducible PAR & ANT

%\newcommand{\cov}{{\mathrm{cov}}}
\newcommand{\Hwignercov}{{\tilde{\Hwigner}}}
\newcommand{\fwignercov}{{\tilde{\fwigner}}}




\newcommand{\Up}{{\uparrow}}
\newcommand{\Down}{{\downarrow}}
\newcommand{\pcircUp}{{\mathring{k}^\Up}}
\newcommand{\pcircDown}{{\mathring{k}^\Down}}
\newcommand{\pcirc}{{\mathring{k}}}

% \DeclareMathOperator*{\SpinEta}{{\Spin(\varepsilon(\eta)\eta)}}
% \DeclareMathOperator*{\SpinEtaZero}{{\Spin^0(\varepsilon(\eta)\eta)}}
\DeclareMathOperator*{\SpinEta}{{\Spin}}
\DeclareMathOperator*{\SpinEtazero}{{\Spin^0}}

% \newcommand{\FF}{{\mathbb{V}}} %% Fermi Fock space
% \newcommand{\FFfin}{{\mathbb{V}_{\textrm{fin}}}} %% Fermi Fock space
% \newcommand{\ff}{{\mathbbm{v}}} %% element of the Fermi Fock space
% \newcommand{\vac}{{\mathrm{Vac}}} %% vacuum state


\usepackage{tikz}
\usetikzlibrary{matrix,arrows.meta}
\usepackage{amsmath}
\DeclareMathOperator{\im}{im}


%%%%%%%%%%%%%%%%%%%
%%% For book document class:
%\usepackage{times,lipsum}
\usepackage[margin=1in]{geometry}
% \usepackage[onehalfspacing]{setspace}
\usepackage[]{setspace}

\newcommand{\chapterabstract}[1]{
  \begin{quote}
    \singlespacing\small
    \rule{14cm}{1pt}\\
    {#1}
    \vskip-4mm
    \rule{14cm}{1pt}
  \end{quote}}
%%%%%%%%%%%%%%%%%% 


%%%%
%%%%%%%%[Notation Dirac Rosetta stone]

%%%% taken from
%%%% https://tex.stackexchange.com/questions/83509/hfill-in-math-mode
\makeatletter
\newcommand{\pushright}[1]{\ifmeasuring@#1\else\omit\hfill$\displaystyle#1$\fi\ignorespaces}
\newcommand{\pushleft}[1]{\ifmeasuring@#1\else\omit$\displaystyle#1$\hfill\fi\ignorespaces}
\makeatother




\title{Deel learning, notes}
\author{L. M. Borasi}
%\email{borasi@iam.uni-bonn.de}
%\affiliation{ 
%Hausdorff Center of Mathematics \& Institute of Applied Mathematics,\\ University of Bonn, Germany
%}%
% 
%\usepackage{xcolor}
%\color{blue} 
%\usepackage{eucal}
\begin{document}
\maketitle
\begin{abstract}
	Personal notes while reading the book~\cite{goodfellowDeepLearning2016}.
\end{abstract}
\tableofcontents


\section{MLP}
\subsection{General notation}\label{sec:general-notation}
Let the output of a NN be a vector $f_{\text{out}}\in \mathcal H_{\text{out}}$ 
where $\mathcal H_{\text{out}}$ is a Hilbert space with scalar product $\langle\cdot,\cdot\rangle$
and Hilbert norm $\|f\|\deq \sqrt{\langle f,f\rangle}$.
 
Consider $(e_i)_{i\in I}$ to be a Hilbert basis of $\mathcal H_{\text{out}}$.
Then
\begin{equation*}
	\| f_{\text{out}} \|^2 = \sum_{i\in I} \langle f_{\text{out}}, e_i \rangle^2 = \sum_{i\in I}  [f_{\text{out}}]_i^2 
	\quad v\in\mathcal H_{\text{out}}
	,
\end{equation*}
where we have used the notation $[f]_i \deq \langle f, e_i\rangle$, $i\in I$, to denote the $i$-th component of $f$.

Similarly let $\mathcal H_{\text{in}}$ the vector space of inputs.
Moreover, let $\mathbb V$ be the vector space of weights.
Following the standard convention we consider a weight $V\in\mathbb V$ to be composed of two components:
$V = (b,w)$ where $b\in \mathbb B$, $w\in\mathbb W$, with $\mathbb V=\mathbb B\oplus\mathbb V$.
An element $W\in\mathbb W$ is a collection of weighted edges which characterize the NN.
An element $B\in\mathbb B$ is the collection of ``additive coefficients'' (see below).

We now consider the \textit{transition function}  $F:\mathcal H_{\text{in}} \times \mathbb V \rightarrow \mathcal H_{\text{out}}$.
This function characterizes the NN completely, in the sense that, given the weights $w\in\mathcal W$ and the inputs $f_{\text{in}}$,
$F(f_{\text{in}}, w)\in\mathcal H_{\text{out}}$ is the output returned by the NN.

We consider the \textit{cost function} $S:\mathbb V\rightarrow \RR$ given by
\begin{equation*}
	S(V) \deq \sum_{f_{\text{in}}\in\mathcal H_{\text{in}}} \| F(f_{\text{in}}, V) - F_\infty(f_{\text{in}}) \|^2,
	\quad V\in\mathbb V
	.
\end{equation*}
Here $F_\infty:\mathcal H_{\text{in}}\rightarrow\mathcal H_{\text{out}}$ is the ``reference function'',
that is a function that returns the ``reference output'' for each input (in principle we could have absorbed $F_\infty$ into $F$,
but for clarity we keep them separated).


\subsection{Gradient descent}

For a fixed $V\in\mathbb V$, consider $\nabla S(V)$ as an element of $\mathbb V$.
Consider the expansion
$$
S(V-\epsilon\nabla S(V)) = S(V) - \epsilon {\|\nabla S(V)\|}^2 + R(V,\epsilon)
\quad V\in \mathcal U\subset\mathbb V,\quad 0<\epsilon<1
.
$$

Let
$\mathcal U \subset \mathbb V$, and $0<\epsilon<1$, such that  $R(w, \epsilon) \le C(U) \epsilon^2$, $w\in U$.
Then
\begin{align*}
	&S(V - \epsilon \nabla S(V) ) = S(V) - \epsilon {\| \nabla S(V) \|}^2  + \epsilon^2 C(\mathcal U)\\
	&S(V - \epsilon \nabla S(V) )  - S(V)  = -\epsilon {\| \nabla S(V) \|}^2+ \epsilon^2 C(\mathcal U)\\
	&\qquad \le -\epsilon  {\| \nabla S(V) \|}^2 + \epsilon^2 |C(\mathcal U)|
	.
\end{align*}
Assume $\|\nabla S(V)\|_{\mathbb V}\| \ne 0$, then
let $\epsilon$ such that $\epsilon|C(\mathcal U)| < \frac12 {\|\nabla S(w)\|}_{\mathcal W}$.
Then 
\begin{equation*}
	S(V - \epsilon \nabla S(V) )  - S(V) < -\frac{\epsilon}{2} {\|\nabla S(V)\|}_{\mathbb V} < 0
		.
\end{equation*}
Hence we have sketched the proof of the following.
\begin{theorem}
	For $U\subset\mathcal W$ compact, and $w\in U$ fixed,
	there exists an $\epsilon>0$ such that
	$$
	S(w-\epsilon\nabla S(w)) \le S(w)
	.
	$$
	and if $\nabla S(w)\ne 0$, then $\le$ can be replaced by $<$.
        \qed{}
\end{theorem}


\subsection{MLP and filtration}
  We consider a MLP  with $N\in\NN$ neurons per layer and $L\in\NN$ layers.
  Let, with reference to  the notation of subsection~\ref{sec:general-notation},
  $\mathcal H^{\text{in}} \deq \RR^N$, $\mathbb B \deq \RR^{N}\times\RR^{L}$, $\mathbb W \deq \RR^{N}\times\RR^N\times\RR^L$.
  Moreover we consider each layer as being the input of the next.
  Therefore we set $\mathcal H$ to be a copy of $\mathcal H^{\text{in}}$
  as the abstract space of inputs (to a generic layer $\ell\in\{1,\dots, L\}$).

  We consider the ``filtration'' over the layers.
  By this we mean the following.
  First, we decompose $\mathbb V =\mathbb B\oplus\mathbb V$ as a direct sum of spaces indexed by the layers:
  \begin{align*}
    \mathbb V &= \underbrace{\mathcal V \oplus\cdots\oplus \mathcal V}_{L \text{ times}} \\
    \mathcal V &= \mathcal B\oplus \mathcal W, \quad \mathcal B\cong\RR^N,\quad\mathcal W\cong\RR^N\times\RR^N
                 .
  \end{align*}
  Then we defined the spaces:
  \begin{align*}
    \mathbb V_{\llbracket \ell + h,\ell\rrbracket} \deq \underbrace{\mathcal V\oplus\cdots\oplus\mathcal V}_{h \text{ times}}
    .
  \end{align*}
  Note that these spaces define a filtration in the mathematical sense,
  i.e. we have a sequence of spaces $\mathbb V_{\llbracket \ell ,0 \rrbracket}$, $\ell\in\{1,\dots,L\}$, which satisfy
  \begin{align*}
    \mathbb V 
    =\mathbb V_{\llbracket L+1 ,0 \rrbracket}\supset \mathbb V_{\llbracket L ,0 \rrbracket}
    \supset \cdots\supset \mathbb V_{\llbracket 1 ,0 \rrbracket} \cong\mathcal V
    .
  \end{align*}
  We employ the same notation for the space $\mathbb B$, $\mathbb W$.
  
  Let $\Phi^\ell:\mathcal H\rightarrow\mathcal H$.
  Usually one takes $\Phi$ of the form
  \begin{align*}
    [\Phi^\ell( x )]_n = \varphi^\ell( x_n ), \quad x=(x_1,\dots,x_N)\in\mathcal H
    ,
  \end{align*}
  where $[\cdot]_n$, $n\in\{1,\dots,N\}$, denotes the $n$-th component of a vector in $\mathcal H$;
  here $\varphi:\RR\rightarrow\RR$ is the activation function of the $n$-th neuron on the $\ell$-th
  layer and every neuron on the same layer has the same activation function.
  It is convenient, to write down more compact formulas, to define
  $$
  \varphi^0(x) \deq x,\quad x\in \RR^N
  ,
  $$
  that is the ``activation function'' for the inputs $\fin\in\mathcal H^{\text{in}}$ is the identity function.
  
  We define recursively the MLP characteristic  function
  $F:\mathbb V\times \mathcal  H_{\text{in}}\rightarrow \mathcal H_{\text{out}}$:
  \begin{equation}
    \label{eq:3}
    \begin{aligned}
      F(V,f) &\deq x^{L+1} , \\
      x^{\ell+1} &\deq b^\ell + w^\ell \varphi^\ell ( x^\ell ),\quad \ell \in \{ 1,\dots , L\} , \\
      x^{0} &= f^{in},
    \end{aligned}
  \end{equation}
  where $v=(w,b)\in\mathcal V$.
  For example for $N=1$ and $L=2$ we have:
  $$
  F(f_{\text{in}},v) \deq  w^{(2)} \varphi( w^{(1)} \varphi( w^{(0)} f_{\text{in}} + b^{(0)} ) + b^{(1)} ) + b^{(2)} 
  .
  $$

  We define the cost function to be $S:\mathbb V \rightarrow\RR$.
  $$
  S(v) \deq \sum_{\fin\in\mathcal H^{\text{in}}} \|F(f_{\text{in}},v) - F_{\infty}(f_{\text{in}} ) \|^2
  .
  $$

  We want to compute the gradient of $S(V) $.
  We want to do this rigorously and explicitly so that the implementation of the algorithm becomes straightforward.
  What the problem with the notation in~\eqref{eq:3} is that each $x^{\ell}$ is an element of $\mathcal H$
  and not a function.
  To take derivative we need a notation which expresses the dependence of the $x^{\ell}$ on the weights (and on each other).
  We do this taking advantage of the ``filtration'', i.e. on the fact that each layer can be thought as having a transition function
  which takes as inputs the outputs of the previous layer.
  
  To express this concretely we define the $\ell$-th ``\textit{layer transition function}'':
  \begin{align*}
    X^{\ell+1}_{v}(x) &\deq b + w\varphi^\ell(x),
                            \quad v=(b,w)\in\mathcal V,
                            \quad x\in\mathcal H
                            \quad \ell\in \{0,\dots, L-1\}
                            .
  \end{align*}
  We then define the ``\textit{filtered transition functions}'' to be the functions $F^{\ell',\ell}$, $\ell'>\ell$,  
  given by
  \begin{align*}
    F^{\ell+h,\ell}(V_{\llbracket L, \ell+1\rrbracket}, x) &\deq X^{\ell+h}_{v^{\ell+h-1}}  (\dots  X^{\ell+2}_{v^{\ell+1}} ( X^{\ell+1} _{v^{\ell}} (x) ) \dots ) \\
                       &\equiv (X^{\ell+h}_{v^{\ell+h-1}} \circ \dots \circ X^{\ell+2}_{v^{\ell+1}}  \circ X^{\ell+1}_{v^{\ell}}  )(x)
                         ,
  \end{align*}
  where
  \begin{align*}
    V_{\llbracket L, \ell+1\rrbracket}
    \deq (v^{\ell+h-1},\dots,v^{\ell+1}, v^{\ell} ) \in\mathbb V_{\llbracket \ell+h-1,\ell\rrbracket} , \quad x\in\mathcal H^\ell
    ,
  \end{align*}
  and  where $\circ$ denotes composition of functions.
  By definition we have  $F^{\ell+1,\ell} \equiv X^{\ell+1}$.
  Moreover, by the ``compositional nature'' of $F^{\ell',\ell}$, we have
  \begin{equation}
    \label{eq:8}
    \begin{aligned}
      F(V,\fin) 
      &= F^{L+1,\ell+1}(V_{\llbracket L, \ell+1\rrbracket}, \, F^{\ell,0}( V_{\llbracket \ell, 0\rrbracket} , \fin) \,)
        ,
        \quad \ell\in\{1,\dots,L\}
        .
    \end{aligned}
  \end{equation}

  With this notation, we can rewrite~\eqref{eq:3} in the following way:
  \begin{equation}
    \label{eq:9}
    \begin{aligned}
      F(V,f^{\text{in}}) &= F^{L+1,0}(V, f^{\text{in}})  , \\
      F^{\ell+1,0}( V_{\llbracket \ell+1,0\rrbracket} , f^{\text{in}}  )
                         &= b^\ell + w^\ell \varphi^\ell( F^{\ell,0}( V_{\llbracket \ell-1,0\rrbracket} , f^{\text{in}}) ) ,
                           \quad \ell\in\{0,\dots, L\} 
                           .
    \end{aligned}
  \end{equation}
  We further rewrite these relations in a way that makes the parallel with~\eqref{eq:3} obvious.
  Note first that
  \begin{align*}
    F^{\ell+1,0}( V_{\llbracket \ell+1,0\rrbracket}, \fin )
    &= X^{\ell+1}_{v^\ell} ( X^\ell_{v^{\ell-1}} ( a^\ell ) ), \\
    F^{\ell,0}
    &= X^{\ell}_{v^{\ell-1}}( a^\ell ) , \\
    a &\equiv F^{\ell-1,0}( V_{\llbracket \ell-1,0\rrbracket} , f^{\text{in}}  )
        .
  \end{align*}
  Then we can rewrite~\eqref{eq:3} as follows
  \begin{equation}
    \label{eq:10}
    \begin{aligned}
      F(V,f^{\text{in}}) &=  X^{L}_{v^L}(  a^{L-1} ), \\
      X^{\ell+1}_{v^\ell}( X^\ell_{v^{\ell-1}} ( a^{\ell-1} ) )
                         &=  b^\ell + w^\ell  \varphi^\ell ( X^{\ell}_{v^{\ell-1}} ( a^{\ell-1} ) ),
                           \quad \ell\in\{0,\dots, L\} 
                           .
    \end{aligned}
  \end{equation}
  Here and in~\eqref{eq:9} the symbol $a$ is simply a place-holder to make the formulas more palatable.  
  Comparing~\eqref{eq:10} with~\eqref{eq:3}, we see that we have the same form or inductive relation but in~\eqref{eq:10} the symbols
  $X^{\ell}$ are now functions.

  Strong of this (perhaps a bit over complicated..) notation we are ready to compute the gradient $\nabla S$.

  \subsection{Back-propagation}
  For convenience we call \textit{gradient} both the gradient of a scalar-valued function and the Jacobian of a vector valued function.
  We shall use the ``chain-rule'' for the gradient in the following form
  (cf.~ \cite[formula (1.4) p. 23, and Theorem (2.3) p. 27]{boothbyIntroductionDifferentiableManifolds2003}).
  Given two functions $F:\RR^\mu\rightarrow\RR^\nu$, $G:\RR^\nu\rightarrow \RR^\rho $, $\mu,\nu,\rho\in\NN$, we let
  $H\deq G\circ F:\RR^\mu\rightarrow\RR^\rho$.
  Then we have
  \begin{equation}
    \label{eq:5}
    (DH)( a ) = (DG)( F(a) ) (DF)(a), \quad a\in\RR^\nu
    ,
  \end{equation}
  where $DF$ and $DG$ represent the gradients of $F$ and $G$ 
  and
  where on the right-hand side we have the matrix product of the matrix $(DG)( F(x) )$ with the matrix $(DF)(x)$.

  Before computing the derivatives we introduce three notational conventions which will make the formulas clearer.

  First: Consider a filtered transition function $F^{\ell',\ell}:\mathbb V_{\llbracket \ell' , \ell \rrbracket} \times\mathcal H\rightarrow \mathcal H$,
  $\ell'>\ell$, $\ell',\ell\in\{0,\dots,L+1\}$.
%  We denote the gradient of $F^{\ell',\ell}$ by $\mathcal D F^{\ell',\ell}$.
  Since $F^{\ell',\ell}$ is a function of a pair of vector-variables $(V_{\llbracket \ell' , \ell \rrbracket},x)$,
  where
  $V_{\llbracket \ell' , \ell \rrbracket}\in\mathbb V_{\llbracket \ell' , \ell \rrbracket}$ are the weights, and
  $x\in\mathcal H$ are the inputs,
  we distinguish the gradients with respect to each of these variables.
  We denote the gradient with respect to the weights by $\nabla F^{\ell',\ell}$
  and we denote the gradient with respect  to the inputs by $\mathtt D F^{\ell',\ell}$.

  Second: In computing the gradient, we want to take advantage of the ``compositional nature'' of the transition function.
  To express this in the notation we define a gradient $\nabla^\ell$ to denote the gradient with respect to the variable
  $v^\ell$ which lives in the $\ell$-th component of the decomposition
  $\mathbb V=\underbrace{\mathcal V\oplus\cdots\oplus\mathcal V}_{L\text{ times}}$.

  Third: Given two vectors $x,y\in\mathcal H$ we have the scalar product $\langle x, y\rangle\in\RR$.
  We shall need an expression for pairing, instead of just two vectors, two tensors of different degree,
  i.e. two arrays of different shape.
  Let  $T\in\mathcal H^{\otimes d}$, respectively   $T'\in\mathcal H^{\otimes d'}$,
  be a tensor of degree $d\in\NN$, respectively $d'\in\NN$.
  This means that for example $T$ is represented by an array with $d$ indices:
  $[T]_{n_1,\dots,n_d}$, $n_j\in\{1,\dots, N \}$ ($N$ being as before the dimension of $\mathcal H$).
  We define the binary operation $\boldcol$  as follows.
  It sends  $T,T'$ into the matrix $T\boldcol T'$ obtained by
  contracting the right-most index of $T$ with the left-most index of $T'$.
  That is $T\boldcol T'$ is a tensor of degree $d-1+d'-1 =d+d'-2$ of components:
  \begin{align*}
    [ T\boldcol T' ]_{n_1,\dots,n_{d-1}, n'_2,\dots, n'_{d'}}
    &\deq \sum_{m=1}^N [T]_{n_1,\dots,n_{d-1},m} [T']_{m,n'_2,\dots,n'_{d'}}
    .
  \end{align*}
  For two vectors $x,y\in\mathcal H$ we have $x\boldcol y =\langle x,y\rangle$.
  For two matrices $A,B\in\mathcal H\otimes\mathcal H$ we have $A\boldcol B = AB$
  where $AB$ denotes the standard matrix product of $A$ and $B$.
  As this last example shows, the binary operation is \textit{not} symmetric (i.e. commutative) in general.
    
  With all of this out of the way,  we compute step by step the derivatives:
  First we have:  
  \begin{align*}
    [\nabla^\ell S(v)]_n
    &= \frac{\partial}{\partial [v^\ell]_n} S(v) \\
    &= \sum_{\fin\in\mathcal H^{\text{in}}} \frac{\partial}{\partial [v^\ell]_n} \sum_m (F_m(V,\fin) - [F_\infty]_m  )^2 \\
    &= \sum_{\fin\in\mathcal H^{\text{in}}} \sum_m 2(F_m(V,\fin) - [F_\infty]_m)\frac{\partial}{\partial [v^\ell]_n} F_m(V,\fin)\\
    &= \sum_{\fin\in\mathcal H^{\text{in}}} \sum_m \big( \frac{\partial}{\partial [v^\ell]_n} F_m(V,\fin) \big) 2(F_m(V,\fin) - [F_\infty]_m)
    .
  \end{align*}
  We compactly denote this, employing binary operation $\boldcol$ defined above, as follows
  \begin{align*}
    \nabla^\ell S(V)
    &= \sum_{\fin\in\mathcal H^{\text{in}}}  \nabla^\ell F(V) \boldcol  2(F(V,\fin) - F_\infty)  ,
      \quad      V\in\mathbb V,
      \quad \ell\in\{0,\dots,L\}
      .
  \end{align*}

  
  Second, we want to compute $\nabla^\ell F$.
  We employ the chain rule as in~\eqref{eq:5}. 
  The straight forward specialization of this formula to our case reeds\footnote{This is a complicated way to write:
    \begin{align*}
      \frac{\partial F_k(v)}{\partial v^\ell} 
      &= \frac{\partial x^L}{\partial v^\ell} \\
      &= \frac{\partial x^L}{\partial x^{\ell+1} }\frac{\partial x^{\ell+1}}{\partial v^\ell}
        .
    \end{align*}
    In this way we reduce the problem of computing the gradient $\nabla F$ to the problem of
    computing the partial derivatives $\partial x^L / \partial x^{\ell+1}$.
    These derivatives can be computed recursively (applying again the chain rule). This is the origin of the name \textit{back-propagation}.
    Indeed,  we have
    \begin{equation}\label{eq:1}
      \begin{aligned}
        \frac{\partial x^{L+1}}{\partial x^{\ell+1}}
        &= \frac{\partial x^{L+1}}{\partial x^{\ell+2}}\frac{\partial x^{\ell+1}}{\partial x^{\ell+1}}
          .
      \end{aligned}
    \end{equation}
    We rewrite this in terms of the more rigorous notation employing the functions $F^{\ell',\ell}$.
 }:
  \begin{equation}\label{eq:4}
    \begin{aligned}
      \nabla^{\ell-1} F(V,\fin)
      &= \nabla^{\ell-1} F^{L,\ell+1}([V]_{L,\ell}, F^{\ell,0}([V]_{\ell-1,0} , \fin ) ) \\
      &= (\mathtt D F^{L+1,\ell+1})([V]_{L,\ell}, F^{\ell,0}([V]_{\ell,0}, \fin ) ) (\nabla^{\ell-1}  F^{\ell,0})([V]_{\ell-1,0} , \fin )
        ,
    \end{aligned}
  \end{equation}
  where       
  \begin{align*}
    V = (v^{L-1},\dots, v^0),\quad [V]_{L-1,\ell} =(v^{L-1},\dots, v^{\ell}),\quad [V]_{\ell-1,0}=(v^{\ell-1},v^0)
    .
  \end{align*}

  In formula~\eqref{eq:4} the term $ (\nabla^{\ell-1}  F^{\ell,0})([V]_{\ell-1,0} , \fin )$ can already be written down explicitly.
  To write it down we recall that the weight $v^\ell$ is composed of two parameters:  $v^\ell=(b^\ell,w^\ell)$.
  Hence we denote by $\nabla^\ell_b$, respectively $\nabla^\ell_w$, the gradient with respect to $b^\ell$, respectively $w^\ell$.
  We obtain:
  \begin{equation*}
    \begin{aligned}
      (\nabla^{\ell-1}_b  F^{\ell,0})([V]_{\ell-1,0} , \fin ) &= \id,\\
      (\nabla^{\ell-1}_w  F^{\ell,0})([V]_{\ell-1,0} , \fin ) &= \Phi^{\ell-1}(  F^{\ell-1,0}([V]_{\ell-2,0}, \fin  )
                                                                ,
    \end{aligned}
  \end{equation*}
  where $\id$ denotes the identity $N\times N$ matrix (that is the identity on $\mathcal H$).

  Third:
  The term $(D F^{L+1,\ell+1})([V]_{L,\ell}, F^{\ell,0}([V]_{\ell,0}, \fin ) )$, on the right-hand side of~\eqref{eq:4},
  can be computed by applying again the chain rule~\eqref{eq:5}.
  In this way we get the following recursive relation which is the origin of the name \textit{back-propagation}:
  \begin{equation}\label{eq:6}
    \begin{aligned}
      (D F^{L+1,\ell-1})(V_{\llbracket \ell - 2 , 0 \rrbracket } , F^{\ell-2,0}(V_{\llbracket \ell-3 , 0 \rrbracket } , \fin ) )
      &= (D F^{L+1,\ell})([V]_{L,\ell-1}, X^{\ell-1}_{v^{\ell-2}} ( F^{\ell-2,0}([V]_{\ell-3,0}, \fin ) ) )\mathbf\cdot\\
      & \hspace{3.5cm}\mathbf\cdot  (DX^{\ell-1}_{v^{\ell-2}}) ( F^{\ell-2,0}([V]_{\ell-3,0}, \fin ) ) )
        ,
    \end{aligned}
  \end{equation}
  where, on the right hand side the $\cdot$ denotes matrix multiplication.
  Note that the term $DX^{\ell-1}_{v^{\ell-2}}$ in~\eqref{eq:6} can be computed explicitly.
  Define the ``place-holder''
  \begin{align*}
    a^{\ell-2} &\equiv F^{\ell-2,0}( V_{\llbracket \ell-3,0\rrbracket} , f^{\text{in}}  ) \in\mathcal H
                 .
  \end{align*}
  We get
  \begin{align*}
    [(DX^{\ell-1}_{v^{\ell-2}}) ( a^{\ell-2} ) )]_{nm}
    &=  \frac{\partial}{\partial x_n}  \big( b^{\ell-2}_m + \sum_k w_{mk}\Phi_k( x ) \big)\Big|_{x = a^{\ell-2}} \\
    &=   \sum_k w_{mk} \frac{\partial}{\partial x_n} \Phi_k( x )  \Big|_{x = a^{\ell-2}} \\
    &=   \sum_k w_{mk}  [D\Phi( x )]_{nk}  \Big|_{x = a^{\ell-2}} \\
    &=   w [D\Phi( a^{\ell-2} )]_{nk} \\
    .
  \end{align*}
  Note that 
  \begin{equation}
    \label{eq:12}
    \begin{aligned}
      [D\Phi(a)]_{nk}
      &=  \frac{\partial}{\partial x_n} \varphi( x_k ) \Big|_{x = a^{\ell-2} } \\
      &=  \varphi' ( x_k )  \frac{\partial x_k}{\partial x_n}\Big|_{x = a^{\ell-2} } \\
      &=  \varphi' ( x_k )  \delta_{nk} \Big|_{x = a^{\ell-2} } \\
      &= \varphi'( [a]_n) \delta_{nk} \text{ (no sum over repeated indices) }
        .
    \end{aligned}
  \end{equation}
  Hence,~\eqref{eq:6} becomes:
  \begin{equation}\label{eq:11}
    \begin{aligned}
      (D F^{L+1,\ell-1})(V_{\llbracket \ell - 2 , 0 \rrbracket } , a^{\ell-2} )
      &= (D F^{L+1,\ell})([V]_{L,\ell-1}, X^{\ell-1}_{v^{\ell-2}} ( a^{\ell-2} ) ) \boldsymbol\cdot (DX^{\ell-1}_{v^{\ell-2}}) ( a^{\ell-2} ) ) \\
            &=  D\Phi(a^{\ell-2}) \boldsymbol\cdot  (D F^{L+1,\ell})(V_{\llbracket L,\ell-1\rrbracket}, X^{\ell-1}_{v^{\ell-2}} ( a^{\ell-2} ) ) 
        ,
    \end{aligned}
  \end{equation}

  
  To obtain this formula we had to express each object as a function, so that we could differentiate with respect to its argument.
  Now, to clarify the implementation of this formula, we go back to a ``declarative'' notation as in~\eqref{eq:1}.
  We fix the weights $V\in\mathbb V$ and the inputs $\fin\in\mathcal H^{\text{in}}$, then we let
  \begin{align*}
    \mathbf J^{\ell} := (D F^{L+1,\ell})(V_{\llbracket \ell - 1 , 0 \rrbracket } , a^{\ell-1} , \fin ) )
    ,
  \end{align*}
  where as usual we have the ``place-holder''
  $a^{\ell-1} =  F^{\ell-1,0}( V_{\llbracket \ell-2,0\rrbracket} , f^{\text{in}}  ) \in\mathcal H $.
  Note that
  \begin{align*}
    (D F^{L+1,\ell})(V_{\llbracket L,\ell-1\rrbracket}, X^{\ell-1}_{v^{\ell-2}} ( a^{\ell-2} ) )
    &= (D F^{L+1,\ell})(V_{\llbracket L,\ell-1\rrbracket}, a^{\ell-1}  )
      .
  \end{align*}
  Hence, from formula~\eqref{eq:11}, we get the ``back-propagating'' recursive relation
  \begin{align*}
    \mathbf J^{\ell-1}  = \mathtt D\Phi^{\ell-1}(a^{\ell-2}) \boldsymbol\cdot \mathbf J^{\ell} ,
    \quad \ell\in\{1,\dots,L+1\}
    .
  \end{align*}
  This formula is ``backward-propagating'' in the sense that to compute the gradient of the function $F^{\text{out},\ell+1}$
  which takes as input the outputs of the layer $\ell$ we use the gradient of the function $F^{\text{out},\ell+2}$
  which takes as inputs the outputs of the following layer $\ell+1$, this means that we are ``propagating backward''
  from the layer $\ell+1$ to the layer $\ell$.
  
  We put everything together in a formula ready for implementation.
  \begin{proposition}
    With notation as above we have
    \begin{align*}
      a^{\ell} &=  x^\ell ,\\
      [\mathtt D\Phi^\ell(a^{\ell-1})]_{nm} &= {} ,\\
      \mathbf J^{\ell-1} &= \prod_{\ell'=\ell}^L \mathtt D\Phi^{\ell'-1}(a^{\ell'-2}) ,\\
                           \nabla^\ell F(V,\fin) &= {} ,\\ 
      \nabla^\ell S(V) &= {}
                         .
    \end{align*}
  \end{proposition}




% \newpage
% \subsection*{}

% \newpage

%\nocite{*}
%\bibliography{aipsamp}% Produces the bibliography via BibTeX.
%\bibliographystyle{plain}%  
\bibliographystyle{amsalpha}%   
\bibliography{ML}% 
     
\end{document}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:



